#!/bin/bash

set -e

# Parse installation mode
MODE="dev"  # Default to dev mode
SYSTEMD_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --production)
            MODE="production"
            shift
            ;;
        --dev)
            MODE="dev"
            shift
            ;;
        --systemd)
            SYSTEMD_ONLY=true
            shift
            ;;
        *)
            echo "Usage: $0 [--production|--dev] [--systemd]"
            echo ""
            echo "Installation modes:"
            echo "  --production: Full install for production (venv at /opt/rec/venv, FTP, SELinux, systemd)"
            echo "  --dev:        Full install for development (venv at .venv, FTP, SELinux, no systemd by default)"
            echo ""
            echo "Optional flags:"
            echo "  --systemd:    Only configure systemd services (skips FTP, SELinux, venv)"
            echo ""
            echo "Examples:"
            echo "  $0 --production           # Full production install"
            echo "  $0 --dev                  # Full dev install"
            echo "  $0 --production --systemd # Only set up systemd for production"
            echo "  $0 --dev --systemd        # Only set up systemd for dev"
            exit 1
            ;;
    esac
done

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [[ "$SYSTEMD_ONLY" == true ]]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ SYSTEMD-ONLY MODE - ${MODE^^}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Install directory: $SCRIPT_DIR"
    echo ""
    echo "Skipping: FTP setup, SELinux, Python venv"
    echo "Setting up: Systemd services only"
    echo ""
else
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“¦ DATALOGGER INSTALLATION - ${MODE^^} MODE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Install directory: $SCRIPT_DIR"
    echo ""
fi

# Configure paths based on mode
if [[ "$MODE" == "production" ]]; then
    VENV_DIR="/opt/rec/venv"
    VENV_PYTHON="$VENV_DIR/bin/python"
else
    VENV_DIR="$SCRIPT_DIR/.venv"
    VENV_PYTHON="$VENV_DIR/bin/python"
fi

# Stuff for Systemd
AUTOMATION_NAME="datalogger"
AUTOMATION_SCRIPT="$SCRIPT_DIR/automation.py"
AUTOMATION_SERVICE="/etc/systemd/system/${AUTOMATION_NAME}.service"

UPLOAD_DIR="/srv/ftp/upload"

# Skip full installation if systemd-only mode
if [[ "$SYSTEMD_ONLY" == true ]]; then
    echo "[*] Skipping full installation (--systemd flag set)"
    echo ""
else

echo "[*] Installing vsftpd..."

# Detect package manager
if command -v dnf &> /dev/null; then
    sudo dnf install -y vsftpd python3 python3-pip python-tkinter
elif command -v apt &> /dev/null; then
    sudo apt update && sudo apt install -y vsftpd python3 python3-pip python3-tkinter
else
    echo "Unsupported package manager. Install vsftpd manually."
    exit 1
fi

echo "[*] Creating upload directory..."
sudo mkdir -p "$UPLOAD_DIR"
sudo chmod 777 "$UPLOAD_DIR"
sudo chown ftp:ftp "$UPLOAD_DIR"

sudo mkdir -p /var/run/vsftpd/empty
sudo chown root:root /var/run/vsftpd/empty
sudo chmod 755 /var/run/vsftpd/empty

echo "[*] Locating vsftpd.conf..."
if [[ -f /etc/vsftpd.conf ]]; then
    CONF_PATH="/etc/vsftpd.conf"
elif [[ -f /etc/vsftpd/vsftpd.conf ]]; then
    CONF_PATH="/etc/vsftpd/vsftpd.conf"
else
    echo "âŒ Cannot find vsftpd.conf!"
    exit 1
fi

echo "[*] Backing up original vsftpd.conf..."
sudo cp "$CONF_PATH" "$CONF_PATH.bak"

echo "[*] Writing new vsftpd.conf..."
cat <<EOF | sudo tee "$CONF_PATH" > /dev/null
# This file is automatically generated by the VF_Data_Logger program. 
# See vsftpd.conf.bak for the original
#
listen=NO
listen_ipv6=YES
anonymous_enable=YES
local_umask=002
anon_upload_enable=YES
anon_mkdir_write_enable=YES
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=NO
xferlog_file=/var/log/vsftpd.log
pam_service_name=vsftpd
anon_other_write_enable=YES
log_ftp_protocol=YES
ftp_username=ftp
anon_root=/srv/ftp
anon_umask=002
file_open_mode=0664
write_enable=YES

EOF

echo "[*] Opening FTP port in firewall (if applicable)..."
if command -v firewall-cmd &> /dev/null; then
    sudo firewall-cmd --permanent --add-service=ftp
    sudo firewall-cmd --reload
fi

echo "[*] Checking if SELinux exists..."

# Check if SELinux is installed
if ! command -v getenforce &> /dev/null; then
    echo "SELinux is not installed."
else
    echo "SELinux is installed. Configuring..."
    sudo setsebool -P allow_ftpd_anon_write=1
    sudo setsebool -P httpd_can_network_connect=1
    sudo semanage fcontext -a -t public_content_rw_t "($UPLOAD_DIR)(/.*)?"
    sudo restorecon -Rv $UPLOAD_DIR

    # Set SELinux context for Apache to write to datalogger directory
    echo "[*] Setting SELinux context for /var/lib/datalogger..."
    sudo semanage fcontext -a -t httpd_sys_rw_content_t "/var/lib/datalogger(/.*)?"
    sudo mkdir -p /var/lib/datalogger
    sudo restorecon -Rv /var/lib/datalogger

    # Systemd permissions - compile and load policy on target system
    echo "[*] Compiling and loading SELinux policy module..."
    if [[ -f "$SCRIPT_DIR/datalogger.te" ]]; then
        cd "$SCRIPT_DIR"
        if sudo checkmodule -M -m -o datalogger.mod datalogger.te 2>/dev/null && \
           sudo semodule_package -o datalogger.pp -m datalogger.mod 2>/dev/null && \
           sudo semodule -i datalogger.pp 2>/dev/null; then
            echo "âœ… SELinux policy module compiled and loaded successfully"
            # Clean up build artifacts
            sudo rm -f datalogger.mod datalogger.pp
        else
            echo "âš ï¸  Warning: Could not compile/load SELinux policy module"
            echo "    The datalogger service may need manual SELinux permissions"
            echo "    If you encounter permission issues, run:"
            echo "    sudo setsebool -P systemd_read_user_home_files 1"
        fi
    else
        echo "âš ï¸  Warning: datalogger.te not found, skipping SELinux policy"
    fi
fi


echo "[*] Restarting vsftpd..."
sudo systemctl restart vsftpd
sudo systemctl enable vsftpd

echo ""
echo "âœ… FTP server is running."
echo "ğŸ“‚ Anonymous uploads are allowed at: ftp://<your-ip-address>/upload/"
echo "   (Replace <your-ip-address> with the IP of this machine.)"

echo ""
echo "[*] Creating Python virtual environment at $VENV_DIR..."
if [[ "$MODE" == "production" ]]; then
    sudo mkdir -p "$(dirname "$VENV_DIR")"
    sudo python3 -m venv "$VENV_DIR"
    sudo "$VENV_DIR/bin/pip" install -r "$SCRIPT_DIR/requirements.txt"
    echo "âœ… Production venv created at $VENV_DIR"
else
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install -r "$SCRIPT_DIR/requirements.txt"
    echo "âœ… Dev venv created at $VENV_DIR"
fi

fi  # End of full installation (skipped if --systemd)

# Systemd setup - runs in production mode OR when --systemd flag is used
if [[ "$MODE" == "production" ]] || [[ "$SYSTEMD_ONLY" == true ]]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”§ SYSTEMD SETUP - ${MODE^^} MODE"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Setting up sudo permissions for service management..."

    # Create sudoers file for service management
    SUDOERS_FILE="/etc/sudoers.d/datalogger"
    cat <<EOF | sudo tee $SUDOERS_FILE > /dev/null
# Allow webapp to manage datalogger services without password
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl start datalogger.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop datalogger.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart datalogger.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl start xml-watcher.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl stop xml-watcher.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart xml-watcher.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl show datalogger.service
$USER ALL=(ALL) NOPASSWD: /usr/bin/systemctl show xml-watcher.service
EOF

    sudo chmod 0440 $SUDOERS_FILE
    echo "âœ… Sudo permissions configured"

    echo ""
    echo "Creating automation service (XML processing & Unitas uploads)..."

    sudo tee $AUTOMATION_SERVICE > /dev/null <<EOF
[Unit]
Description=Farm Data Logger Automation
After=network.target display-manager.service
Requires=display-manager.service

[Service]
Type=simple
ExecStart=$VENV_PYTHON $AUTOMATION_SCRIPT
WorkingDirectory=$SCRIPT_DIR
Restart=on-failure
User=$USER
Group=$USER

# These ensure logs go to journal
StandardOutput=journal
StandardError=journal

# Allow GUI applications to run (needed for Selenium)
Environment=PYTHONUNBUFFERED=1
Environment=DISPLAY=:0.0
Environment=XAUTHORITY=/run/lightdm/$USER/xauthority
Environment=DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/\$(id -u $USER)/bus
Environment=XDG_RUNTIME_DIR=/run/user/\$(id -u $USER)

[Install]
WantedBy=multi-user.target
EOF

    echo "Reloading systemd..."
    sudo systemctl daemon-reload

    echo "Enabling automation service to start on boot..."
    sudo systemctl enable $AUTOMATION_NAME.service

    echo ""
    echo "âœ… Automation service created!"
    echo "You can start it now with:"
    echo "  sudo systemctl start $AUTOMATION_NAME.service"
    echo ""
    echo "View logs with:"
    echo "  sudo journalctl -u $AUTOMATION_NAME.service -f"

    # Create XML watcher service
    WATCHER_NAME="xml-watcher"
    WATCHER_SCRIPT="$SCRIPT_DIR/watch_xml_dir.py"
    WATCHER_SERVICE_FILE="/etc/systemd/system/${WATCHER_NAME}.service"

    echo ""
    echo "Creating XML directory watcher service..."

    sudo tee $WATCHER_SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=XML Directory Watcher
After=network.target

[Service]
Type=simple
ExecStart=$VENV_PYTHON $WATCHER_SCRIPT
WorkingDirectory=$SCRIPT_DIR
Restart=on-failure
User=root

# These ensure logs go to journal
StandardOutput=journal
StandardError=journal

# Optional: prevent output buffering
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF

    echo "Reloading systemd..."
    sudo systemctl daemon-reload

    echo "Enabling XML watcher service to start on boot..."
    sudo systemctl enable $WATCHER_NAME.service

    echo ""
    echo "âœ… XML watcher service created!"
    echo "You can start it now with:"
    echo "  sudo systemctl start $WATCHER_NAME.service"
    echo ""
    echo "View watcher logs with:"
    echo "  sudo journalctl -u $WATCHER_NAME.service -f"
fi  # End of systemd setup

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ NEXT STEPS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [[ "$SYSTEMD_ONLY" == true ]]; then
    echo "Systemd-only installation complete!"
    echo ""
    echo "ğŸ¤– Systemd services configured for ${MODE^^} mode:"
    echo "   - Working directory: $SCRIPT_DIR"
    echo "   - Python venv: $VENV_PYTHON"
    echo ""
    echo "   Start automation: sudo systemctl start datalogger.service"
    echo "   Start XML watcher: sudo systemctl start xml-watcher.service"
    echo ""
    echo "   View logs:"
    echo "   - sudo journalctl -u datalogger.service -f"
    echo "   - sudo journalctl -u xml-watcher.service -f"
    echo ""
elif [[ "$MODE" == "production" ]]; then
    echo "Production mode installation complete!"
    echo ""
    echo "ğŸ”§ Configuration:"
    echo "   - Edit /var/lib/datalogger/config.json with your farm settings"
    echo "   - Set deployment.mode = \"production\" in config"
    echo ""
    echo "ğŸŒ Apache deployment:"
    echo "   - Code location: $SCRIPT_DIR"
    echo "   - Python venv: $VENV_DIR"
    echo "   - Apache should use WSGIDaemonProcess with python-home=$VENV_DIR"
    echo "   - Restart Apache: sudo systemctl restart httpd"
    echo ""
    echo "ğŸ¤– Systemd services:"
    echo "   - Start automation: sudo systemctl start datalogger.service"
    echo "   - Start XML watcher: sudo systemctl start xml-watcher.service"
    echo ""
else
    echo "Development mode installation complete!"
    echo ""
    echo "ğŸ”§ Configuration:"
    echo "   - Edit ~/.datalogger/config.json with your settings"
    echo "   - Set deployment.mode = \"localhost\" in config"
    echo ""
    echo "ğŸŒ Run webapp locally:"
    echo "   - Activate venv: source $VENV_DIR/bin/activate"
    echo "   - Run webapp: python3 webapp.py"
    echo "   - Access at: http://localhost:5000"
    echo ""
    echo "ğŸ§ª Test automation scripts:"
    echo "   - python3 automation.py --LogToDatabase"
    echo "   - python3 automation.py --LogToUnitas"
    echo ""
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
