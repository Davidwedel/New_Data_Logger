<div id="todaydata" class="tabcontent" style="display:none;">
  <h2>Today's Data</h2>
  <h3>Daily User Log</h3>
  <div id="userlog-container">
    <p>Loading...</p>
  </div>

  <h3>Daily Bot Log</h3>
  <div id="botlog-container">
    <p>Loading...</p>
  </div>
</div>

<script>
  function loadTodayData() {
    fetch('/api/today_data')
      .then(res => res.json())
      .then(data => {
        renderUserLog(data.user_log);
        renderBotLog(data.bot_log);
      })
      .catch(err => {
        console.error('Error loading today data:', err);
        document.getElementById('userlog-container').innerHTML = '<p>Error loading user log.</p>';
        document.getElementById('botlog-container').innerHTML = '<p>Error loading bot log.</p>';
      });
  }

  function renderUserLog(user_log) {
    const container = document.getElementById('userlog-container');

    // Define the expected fields for user log
    const userLogFields = [
      'id', 'date_entered', 'belt_eggs', 'floor_eggs', 'mortality_indoor', 'mortality_outdoor',
      'euthanized_indoor', 'euthanized_outdoor', 'depop', 'amount_delivered', 'mortality_reasons',
      'cull_reasons', 'mortality_comments', 'coolerlog_comments', 'added_supplements',
      'birds_restricted_reason', 'comments', 'weather', 'air_sensory', 'ration',
      'drinkers_clean', 'birds_under_slats', 'safe_indoors', 'safe_outdoors',
      'equipment_functioning', 'predator_activity', 'eggs_picked_up', 'door_open', 'door_closed'
    ];

    // If no user_log, create empty object with all fields
    if (!user_log) {
      user_log = {};
      userLogFields.forEach(field => {
        user_log[field] = '';
      });
    }

    let html = '<div id="userlog-scroll-container" style="max-width:100%; max-height:220px; overflow:auto; border:1px solid #ccc; border-radius:6px;">';
    html += '<form id="userlog-edit-form"><table style="font-size:12px; min-width:600px; margin-bottom:20px;"><tr>';

    // Table headers
    for (const key of userLogFields) {
      html += `<th style="padding:4px 6px;">${key}</th>`;
    }
    html += '</tr><tr>';

    // Table data cells with inputs
    for (const key of userLogFields) {
      const value = user_log[key] || '';
      const isReadonly = key === 'id' || key === 'date_entered' ? 'readonly' : '';

      // Special handling for mortality_reasons and cull_reasons - show dropdown on focus
      if (key === 'mortality_reasons') {
        html += `<td style="padding:4px 6px; position:relative;"><input style="width:100px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showMortalityReasonsDropdown(this)" onblur="hideDropdownDelayed()" onclick="showMortalityReasonsDropdown(this)"></td>`;
      } else if (key === 'cull_reasons') {
        html += `<td style="padding:4px 6px; position:relative;"><input style="width:100px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showCullReasonsDropdown(this)" onblur="hideDropdownDelayed()" onclick="showCullReasonsDropdown(this)"></td>`;
      } else {
        html += `<td style="padding:4px 6px;"><input style="width:100px; font-size:12px;" name="${key}" value="${value}" ${isReadonly} oninput="autoSaveUserLog()" onfocus="scrollUserLogToInput(this)"></td>`;
      }
    }

    html += '</tr></table></form></div>';
    container.innerHTML = html;
  }

  function scrollUserLogToInput(input) {
    const container = document.getElementById('userlog-scroll-container');
    if (!container) return;

    const inputRect = input.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // Scroll horizontally if input is outside visible area
    if (inputRect.right > containerRect.right - 20) {
      container.scrollLeft += (inputRect.right - containerRect.right + 120);
    } else if (inputRect.left < containerRect.left + 20) {
      container.scrollLeft -= (containerRect.left - inputRect.left + 120);
    }
  }

  let currentDropdownInput = null;
  let hideTimeout = null;

  function showMortalityReasonsDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const mortalityOptions = ['Unknown', 'N Natural', 'PR Predator', 'PC Pecking', 'S Sick', 'PL Prolapse', 'C Cull', 'B Broody', 'O Other', 'PI Piling', 'SO Starveout', 'I Injured'];
    const currentValues = input.value ? input.value.split(',').map(v => v.trim()) : [];

    let html = '<div style="padding:10px; max-height:200px; overflow-y:auto;">';
    mortalityOptions.forEach(opt => {
      const checked = currentValues.includes(opt) ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="checkbox" value="${opt}" ${checked} onchange="updateMortalityFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showCullReasonsDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const cullOptions = ['Aggressive', 'Broody', 'Injured', 'Rooster', 'Runt', 'Sick'];
    const currentValues = input.value ? input.value.split(',').map(v => v.trim()) : [];

    let html = '<div style="padding:10px;">';
    cullOptions.forEach(opt => {
      const checked = currentValues.includes(opt) ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="checkbox" value="${opt}" ${checked} onchange="updateCullFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showDropdown(content, inputElement) {
    // Create dropdown positioned relative to the input but outside the scroll container
    const dropdown = document.createElement('div');
    dropdown.id = 'field-dropdown';
    dropdown.innerHTML = content;
    dropdown.onmousedown = (e) => e.preventDefault(); // Prevent blur when clicking inside

    // Position it fixed relative to the input's position on screen
    const rect = inputElement.getBoundingClientRect();
    dropdown.style.cssText = `position:fixed; top:${rect.bottom + 2}px; left:${rect.left}px; background:white; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:10000; min-width:200px;`;

    document.body.appendChild(dropdown);
  }

  function hideDropdown() {
    const dropdown = document.getElementById('field-dropdown');
    if (dropdown) {
      dropdown.remove();
    }
    currentDropdownInput = null;
  }

  function hideDropdownDelayed() {
    // Delay hiding to allow clicking on checkboxes
    hideTimeout = setTimeout(hideDropdown, 200);
  }

  function updateMortalityFromDropdown(checkbox) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    const dropdown = checkbox.closest('div');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const values = Array.from(checkboxes).map(cb => cb.value);

    if (currentDropdownInput) {
      currentDropdownInput.value = values.join(', ');
      autoSaveUserLog();
    }
  }

  function updateCullFromDropdown(checkbox) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    const dropdown = checkbox.closest('div');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const values = Array.from(checkboxes).map(cb => cb.value);

    if (currentDropdownInput) {
      currentDropdownInput.value = values.join(', ');
      autoSaveUserLog();
    }
  }

  let saveTimeout = null;
  function autoSaveUserLog() {
    // Clear any existing timeout
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }

    // Set a new timeout to save after a brief delay (debounce)
    saveTimeout = setTimeout(() => {
      const form = document.getElementById('userlog-edit-form');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        if (key !== 'id' && key !== 'date_entered') {
          data[key] = value;
        }
      });

      fetch('/update_user_log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          console.log('Auto-saved:', result.message);
        })
        .catch(err => {
          console.error('Auto-save failed:', err);
        });
    }, 500); // Wait 500ms after user stops typing
  }

  function renderBotLog(bot_log) {
    const container = document.getElementById('botlog-container');
    if (!bot_log) {
      container.innerHTML = '<p>No bot log for today.</p>';
      return;
    }

    let html = '<div style="max-width:100%; max-height:220px; overflow:auto; border:1px solid #ccc; border-radius:6px;">';
    html += '<form id="botlog-edit-form"><table style="font-size:12px; min-width:600px;"><tr>';
    html += '<th style="padding:4px 6px;">Flag</th>';
    for (const key in bot_log) {
      html += `<th style="padding:4px 6px;">${key}</th>`;
    }
    html += '<th style="padding:4px 6px;">Save</th></tr><tr>';
    html += '<td style="padding:4px 6px;"><input type="checkbox" id="botlog-flag" onchange="setFlag(\'BOT_LOG_FLAG\', this.checked)"></td>';
    for (const key in bot_log) {
      const value = bot_log[key] || '';
      html += `<td style="padding:4px 6px;"><input style="width:100px; font-size:12px;" name="${key}" value="${value}"></td>`;
    }
    html += '<td><button type="button" onclick="saveBotLog()">Save</button></td>';
    html += '</tr></table></form></div>';
    container.innerHTML = html;
  }

  function setFlag(flag, checked) {
    if (!checked) return; // Only set flag on check
    fetch('/set_flag', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ flag: flag })
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error setting flag.'));
  }

  function saveUserLog() {
    const form = document.getElementById('userlog-edit-form');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    fetch('/update_user_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error saving user log.'));
  }

  function saveBotLog() {
    const form = document.getElementById('botlog-edit-form');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    fetch('/update_bot_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error saving bot log.'));
  }
</script>
