# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a poultry farm data logging system that:
- Extracts production data from XML files generated by farm equipment
- Stores data in SQLite database (Daily_Bot_Log, Daily_User_Log, Pallet_Log)
- Provides a Flask web interface for data entry and viewing
- Automatically uploads data to Unitas (poultrycloud.com) using Selenium
- Logs cooler temperatures at scheduled times
- Runs as a systemd service for automated daily operations

## Commands

### Running the Application

```bash
# Install dependencies
pip install -r requirements.txt

# Run web app only
python server/main.py --WebApp

# One-shot XML to Database logging
python server/main.py --LogToDatabase

# One-shot Database to Unitas upload
python server/main.py --LogToUnitas

# One-shot Cooler log to Unitas
python server/main.py --CoolerLogToUnitas

# Forever mode (default - runs scheduled jobs + web app)
python server/main.py
```

### Configuration

- `secrets.json` - Contains credentials, Unitas login, timing settings, and XML paths
- `settings.json` - Contains farm-specific settings (hatch_date, birds_arrived_date, nws_station_id)
- Both can be edited via the webapp Settings tab

## Architecture

### Core Data Flow

1. **XML → Database** (scheduled daily at `retrieve_from_xml_time`)
   - `xml_processing.py` parses XML files from farm equipment
   - Extracts temperatures, feed/water consumption, mortality, light timing
   - Converts units (Celsius→Fahrenheit, kg→lbs)
   - Stores in `Daily_Bot_Log` table via `database_helper.py`
   - Deletes old XML files after processing (configurable retention)

2. **Web Interface → Database**
   - `webapp.py` (Flask) serves forms for manual data entry
   - Users log eggs, mortality, weather, observations
   - Data stored in `Daily_User_Log` table
   - Templates: `index.html` (today's data), `all_data.html` (history)

3. **Database → Unitas** (triggered via web UI or CLI)
   - `unitas_manager/unitas_production.py` uses Selenium to automate form filling
   - Merges bot and user logs for target date (default: yesterday)
   - Logs into Unitas using credentials from `secrets.json`
   - `unitas_login.py` handles authentication
   - `unitas_coolerlog.py` handles cooler temperature logging

### State Management

- `.runstate.json` tracks whether daily jobs have run (keys: XML_TO_DB, DB_TO_PRODUCTION, DB_TO_COOLER)
- `runstate.py` manages this state file
- Flags reset at midnight via `jobs.py`

### Key Modules

- **server/main.py** - Entry point, argument parsing, scheduling loop
- **server/jobs.py** - Scheduled job definitions and timing helpers
- **server/database_helper.py** - SQLite operations (setup, insert, update, query)
- **server/xml_processing.py** - XML parsing, temperature extraction, unit conversion
- **server/webapp.py** - Flask routes and API endpoints
- **server/helpers.py** - Utility functions (bird age calculation, settings validation)
- **server/unitas_manager/** - Selenium automation for Unitas website

### Database Schema

- **Daily_Bot_Log** - Automated data from XMLs (temperatures, feed, water, lights, cooler temps)
- **Daily_User_Log** - Manual entries (eggs, mortality reasons, observations, comments)
- **Pallet_Log** - Egg pallet tracking (weight, yolk color)

All tables use date-based primary keys for daily records.

## Important Notes

- XML files are expected in the path specified by `secrets.json["path_to_xmls"]`
- Cooler temperature extraction has tolerance window (`cooler_temp_time_tolerance`)
- Light on/off times are rounded to 15-minute intervals
- Bird age calculated from `settings.json["hatch_date"]` in format "week.day"
- Timezone handling uses ZoneInfo (configured via `secrets.json["time_zone"]`)
- Selenium runs in non-headless mode by default (see `unitas_production.py:28`)
