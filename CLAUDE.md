# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a poultry farm data logging system that:
- Extracts production data from XML files generated by farm equipment
- Stores data in SQLite database (path depends on deployment mode)
- Provides a Flask web interface for data entry and viewing
- Automatically uploads data to Unitas (poultrycloud.com) using Selenium
- Logs cooler temperatures at scheduled times
- Automation and XML watcher run as systemd services
- Webapp can be deployed via Apache/WSGI (production) or localhost (testing)

## Commands

### Running the Application

```bash
# Install dependencies (creates .venv)
./install.sh

# ─── Webapp (choose one deployment mode) ───

# Localhost mode (for testing)
# 1. Set deployment.mode = "localhost" in ~/.datalogger/config.json
# 2. Run:
python3 webapp.py
# Access at: http://localhost:5000

# Apache mode (for production)
# 1. Set deployment.mode = "production" in ~/.datalogger/config.json
# 2. Copy Apache config:
sudo cp rec.davidwedel.com-le-ssl.conf /etc/httpd/conf.d/
# 3. Restart Apache:
sudo systemctl restart httpd
# Access at: https://rec.davidwedel.com

# ─── Automation (systemd service) ───

# Start automation service (XML processing, Unitas uploads)
sudo systemctl start datalogger.service
sudo systemctl status datalogger.service
sudo journalctl -u datalogger.service -f

# Start XML watcher service
sudo systemctl start xml-watcher.service
sudo systemctl status xml-watcher.service

# ─── One-shot commands (for manual runs) ───

# One-shot XML to Database logging
python3 automation.py --LogToDatabase

# One-shot Database to Unitas upload
python3 automation.py --LogToUnitas

# One-shot Cooler log to Unitas
python3 automation.py --CoolerLogToUnitas

# One-shot Cooler log backup
python3 automation.py --CoolerLogToDB
```

### Configuration

Configuration file location depends on deployment mode:
- **Localhost mode**: `~/.datalogger/config.json` (user home directory)
- **Production mode**: `/var/lib/datalogger/config.json` (system directory, used by Apache and systemd services)

Settings organized in sections:
  - `farm`: hatch_date, birds_arrived_date, nws_station_id, floor_eggs_through_belt
  - `unitas`: credentials and settings for Unitas upload
  - `xml`: path to XML files, retention settings, retrieve time
  - `cooler`: AM/PM times and tolerance for temperature logging
  - `system`: timezone, timeout settings
  - `telegram`: bot_token, chat_id for XML watcher notifications
  - `form_defaults`: default values for daily data entry form
  - **`deployment`**: **Controls how the webapp runs**
    - `mode`: "localhost" (testing) or "production" (Apache)
    - `localhost_port`: Port for localhost mode (default: 5000)
    - `localhost_database`: Database path for testing (default: `~/.datalogger/dev_database.db`)
    - `production_database`: Database path for production (default: `/var/lib/datalogger/database.db`)
- Config can be edited via the webapp Settings tab
- On first run, the script creates a default config file that must be edited with your settings
- **Important**: Copy config to production location after setup: `sudo cp ~/.datalogger/config.json /var/lib/datalogger/config.json`
- Automation and XML watcher services always use production config at `/var/lib/datalogger/config.json`

## Architecture

### Core Data Flow

1. **XML → Database** (scheduled daily at `retrieve_from_xml_time`)
   - `xml_processing.py` parses XML files from farm equipment
   - Extracts temperatures, feed/water consumption, mortality, light timing
   - Converts units (Celsius→Fahrenheit, kg→lbs)
   - Stores in `Daily_Bot_Log` table via `database_helper.py`
   - Deletes old XML files after processing (configurable retention)

2. **Web Interface → Database**
   - `webapp.py` (Flask) serves forms for manual data entry
   - Users log eggs, mortality, weather, observations
   - Data stored in `Daily_User_Log` table
   - Templates: `index.html` (today's data), `all_data.html` (history)

3. **Database → Unitas** (triggered via web UI or CLI)
   - `unitas_manager/unitas_production.py` uses Selenium to automate form filling
   - Merges bot and user logs for target date (default: yesterday)
   - Logs into Unitas using credentials from config
   - `unitas_login.py` handles authentication
   - `unitas_coolerlog.py` handles cooler temperature logging

4. **Cooler Log Backup** (scheduled 1 minute after XML → DB)
   - Backs up cooler temperature data to coolerlog database
   - Location: `/var/lib/datalogger/coolerlog/coolerlog.db` (production) or `~/.datalogger/coolerlog/coolerlog.db` (localhost)
   - Tracks backup status via `cooler_to_db_at` timestamp in Daily_Bot_Log

### State Management

- `.runstate.json` tracks whether daily jobs have run (keys: XML_TO_DB, DB_TO_PRODUCTION, DB_TO_COOLER)
- `runstate.py` manages this state file
- Flags reset at midnight via `jobs.py`

### Key Modules

- **automation.py** - Automation service (XML→DB, scheduled jobs). Runs as systemd service. Always uses production DB.
- **webapp.py** - Flask web application for data entry and viewing. Deployment mode determines database path.
- **wsgi.py** - WSGI entry point for Apache deployment. Forces production mode via environment variable.
- **watch_xml_dir.py** - XML directory monitor. Sends Telegram alerts if no new files. Runs as systemd service.
- **server/config.py** - Configuration management with deployment mode support
- **server/jobs.py** - Scheduled job definitions and timing helpers
- **server/database_helper.py** - SQLite operations (setup, insert, update, query, backups)
- **server/xml_processing.py** - XML parsing, temperature extraction, unit conversion
- **server/helpers.py** - Utility functions (bird age calculation, settings validation)
- **server/unitas_manager/** - Selenium automation for Unitas website

### Database Schema

- **Daily_Bot_Log** - Automated data from XMLs (temperatures, feed, water, lights, cooler temps)
- **Daily_User_Log** - Manual entries (eggs, mortality reasons, observations, comments)
- **Pallet_Log** - Egg pallet tracking (weight, yolk color)

All tables use date-based primary keys for daily records.

## Important Notes

- XML files are expected in the path specified by config `xml.path`
- Cooler temperature extraction has tolerance window (`cooler.time_tolerance`)
- Light on/off times are rounded to 15-minute intervals
- Bird age calculated from config `farm.hatch_date` in format "week.day"
- Timezone handling uses ZoneInfo (configured via config `system.time_zone`)
- Selenium runs in non-headless mode by default (see `unitas_production.py:28`)
- **Config file locations**:
  - **Production**: `/var/lib/datalogger/config.json` (used by automation, xml-watcher services and Apache webapp)
  - **Localhost**: `~/.datalogger/config.json` (used when testing webapp locally)
- **Database paths**:
  - **Production**: `/var/lib/datalogger/database.db` (used by automation service and Apache webapp)
  - **Localhost**: `~/.datalogger/dev_database.db` (used when testing webapp locally)
  - Deployment mode is controlled by `deployment.mode` in config.json
- **Backup paths** (follow deployment mode):
  - **Production**: `/var/lib/datalogger/backups/` (database backups) and `/var/lib/datalogger/coolerlog/coolerlog.db` (cooler logs)
  - **Localhost**: `~/.datalogger/backups/` (database backups) and `~/.datalogger/coolerlog/coolerlog.db` (cooler logs)
  - Database backups created every 24 hours by automation service
- XML watcher sends Telegram notifications if bot_token and chat_id are configured
- **Systemd services**: Only `datalogger.service` (automation) and `xml-watcher.service` run as services
- **Webapp deployment**: Run via Apache/WSGI in production, or standalone Flask server for testing
