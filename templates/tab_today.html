<div id="todaydata" class="tabcontent" style="display:block;">
  <h2>Today's Data</h2>
  <h3>Daily User Log</h3>
  <div id="userlog-container">
    <p>Loading...</p>
  </div>

  <h3>Daily Bot Log</h3>
  <div id="botlog-container">
    <p>Loading...</p>
  </div>
</div>

<script>
  function loadTodayData() {
    // Load both today's data and defaults
    Promise.all([
      fetch('/api/today_data').then(res => res.json()),
      fetch('/get_defaults').then(res => res.json())
    ])
      .then(([todayData, defaults]) => {
        // If no user_log exists, apply defaults
        if (!todayData.user_log) {
          todayData.user_log = defaults;
        }
        renderUserLog(todayData.user_log);
        renderBotLog(todayData.bot_log);
      })
      .catch(err => {
        console.error('Error loading today data:', err);
        document.getElementById('userlog-container').innerHTML = '<p>Error loading user log.</p>';
        document.getElementById('botlog-container').innerHTML = '<p>Error loading bot log.</p>';
      });
  }

  function renderUserLog(user_log) {
    const container = document.getElementById('userlog-container');

    // Define the expected fields for user log
    const userLogFields = [
      'date_entered',
      'belt_eggs',
      'floor_eggs',
      'mortality_indoor',
      'mortality_outdoor',
      'euthanized_indoor',
      'euthanized_outdoor',
      'mortality_reasons',
      'cull_reasons',
      'mortality_comments',
      'eggs_picked_up',
      'coolerlog_comments',
      'added_supplements',
      'ration',
      'amount_delivered',
      'birds_restricted_reason',
      'comments',
      'weather',
      'air_sensory',
      'drinkers_clean',
      'birds_under_slats',
      'safe_indoors',
      'safe_outdoors',
      'equipment_functioning',
      'predator_activity',
      'depop',
      'door_open',
      'door_closed'
    ];

    // Define display names for fields
    const fieldDisplayNames = {
      'id': 'ID',
      'date_entered': 'Date Entered',
      'belt_eggs': 'Belt Eggs',
      'floor_eggs': 'Floor Eggs',
      'mortality_indoor': 'Mortality Indoor',
      'mortality_outdoor': 'Mortality Outdoor',
      'euthanized_indoor': 'Euthanized Indoor',
      'euthanized_outdoor': 'Euthanized Outdoor',
      'depop': 'Depop #',
      'amount_delivered': 'Amount Delivered',
      'mortality_reasons': 'Mortality Reasons',
      'cull_reasons': 'Cull Reasons',
      'mortality_comments': 'Mortality Comments',
      'coolerlog_comments': 'Cooler Log Comments',
      'added_supplements': 'Added Supplements',
      'birds_restricted_reason': 'Birds Restricted Reason',
      'comments': 'Comments',
      'weather': 'Weather',
      'air_sensory': 'Air Sensory',
      'ration': 'Ration Delivered',
      'drinkers_clean': 'Drinkers Clean',
      'birds_under_slats': 'Birds Under Slats',
      'safe_indoors': 'Safe Indoors',
      'safe_outdoors': 'Safe Outdoors',
      'equipment_functioning': 'Equipment Functioning',
      'predator_activity': 'Predator Activity',
      'eggs_picked_up': 'Eggs Picked Up',
      'door_open': 'Door Open',
      'door_closed': 'Door Closed'
    };

    // If no user_log, create empty object with all fields
    if (!user_log) {
      user_log = {};
      userLogFields.forEach(field => {
        user_log[field] = '';
      });
    }

    let html = '<div id="userlog-scroll-container" style="max-width:100%; max-height:600px; overflow:auto; border:1px solid #ccc; border-radius:6px; padding:10px;">';
    html += '<form id="userlog-edit-form">';
    html += '<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 200px)); gap:10px;">';

    // Render each field as a labeled input in a grid
    for (const key of userLogFields) {
      const value = user_log[key] || '';
      const isReadonly = key === 'id' || key === 'date_entered' ? 'readonly' : '';
      const displayName = fieldDisplayNames[key] || key;

      html += `<div style="display:flex; flex-direction:column;">`;
      html += `<label style="font-weight:bold; margin-bottom:2px; font-size:11px;">${displayName}</label>`;

      // Special handling for fields with dropdowns
      if (key === 'mortality_reasons') {
        html += `<input style="padding:4px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showMortalityReasonsDropdown(this)" onblur="hideDropdownDelayed()" onclick="showMortalityReasonsDropdown(this)">`;
      } else if (key === 'cull_reasons') {
        html += `<input style="padding:4px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showCullReasonsDropdown(this)" onblur="hideDropdownDelayed()" onclick="showCullReasonsDropdown(this)">`;
      } else if (key === 'air_sensory') {
        html += `<input style="padding:4px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showAirSensoryDropdown(this)" onblur="hideDropdownDelayed()" onclick="showAirSensoryDropdown(this)">`;
      } else if (key === 'weather') {
        html += `<input style="padding:4px; font-size:12px; cursor:pointer;" name="${key}" value="${value}" readonly onfocus="showWeatherDropdown(this)" onblur="hideDropdownDelayed()" onclick="showWeatherDropdown(this)">`;
      } else if (key === 'eggs_picked_up' || key === 'drinkers_clean' || key === 'birds_under_slats' || key === 'safe_indoors' || key === 'safe_outdoors' || key === 'equipment_functioning' || key === 'predator_activity') {
        const isChecked = (value === 'Yes' || value === 'true' || value === true) ? 'checked' : '';
        html += `<input type="checkbox" name="${key}" ${isChecked} onchange="updateCheckboxField(this)" style="width:18px; height:18px;">`;
      } else {
        html += `<input style="padding:4px; font-size:12px;" name="${key}" value="${value}" ${isReadonly} oninput="autoSaveUserLog()">`;
      }

      html += `</div>`;
    }

    html += '</div></form></div>';
    container.innerHTML = html;
  }

  function scrollUserLogToInput(input) {
    const container = document.getElementById('userlog-scroll-container');
    if (!container) return;

    const inputRect = input.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // Scroll horizontally if input is outside visible area
    if (inputRect.right > containerRect.right - 20) {
      container.scrollLeft += (inputRect.right - containerRect.right + 120);
    } else if (inputRect.left < containerRect.left + 20) {
      container.scrollLeft -= (containerRect.left - inputRect.left + 120);
    }
  }

  let currentDropdownInput = null;
  let hideTimeout = null;

  function showMortalityReasonsDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const mortalityOptions = ['Unknown', 'N Natural', 'PR Predator', 'PC Pecking', 'S Sick', 'PL Prolapse', 'C Cull', 'B Broody', 'O Other', 'PI Piling', 'SO Starveout', 'I Injured'];
    const currentValues = input.value ? input.value.split(',').map(v => v.trim()) : [];

    let html = '<div style="padding:10px; max-height:200px; overflow-y:auto;">';
    mortalityOptions.forEach(opt => {
      const checked = currentValues.includes(opt) ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="checkbox" value="${opt}" ${checked} onchange="updateMortalityFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showCullReasonsDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const cullOptions = ['Aggressive', 'Broody', 'Injured', 'Rooster', 'Runt', 'Sick'];
    const currentValues = input.value ? input.value.split(',').map(v => v.trim()) : [];

    let html = '<div style="padding:10px;">';
    cullOptions.forEach(opt => {
      const checked = currentValues.includes(opt) ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="checkbox" value="${opt}" ${checked} onchange="updateCullFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showAirSensoryDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const airSensoryOptions = ['1', '2', '3', '4', '5'];
    const currentValue = input.value;

    let html = '<div style="padding:10px;">';
    airSensoryOptions.forEach(opt => {
      const checked = currentValue === opt ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="radio" name="air_sensory_dropdown" value="${opt}" ${checked} onchange="updateAirSensoryFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showWeatherDropdown(input) {
    hideDropdown(); // Close any existing dropdown

    const weatherOptions = ['Cloudy', 'Cloudy/Windy', 'Freezing Rain', 'Mostly Cloudy', 'Partly Cloudy', 'Partly Sunny', 'Rain', 'Severe Storm', 'Sleet', 'Snow', 'Sunny', 'Winter Storm'];
    const currentValue = input.value;

    let html = '<div style="padding:10px; max-height:300px; overflow-y:auto;">';
    weatherOptions.forEach(opt => {
      const checked = currentValue === opt ? 'checked' : '';
      html += `<label style="display:block; margin:3px 0; white-space:nowrap;"><input type="radio" name="weather_dropdown" value="${opt}" ${checked} onchange="updateWeatherFromDropdown(this)"> ${opt}</label>`;
    });
    html += '</div>';

    showDropdown(html, input);
    currentDropdownInput = input;
  }

  function showDropdown(content, inputElement) {
    // Create dropdown positioned relative to the input but outside the scroll container
    const dropdown = document.createElement('div');
    dropdown.id = 'field-dropdown';
    dropdown.innerHTML = content;
    dropdown.onmousedown = (e) => e.preventDefault(); // Prevent blur when clicking inside

    // Position it fixed relative to the input's position on screen
    const rect = inputElement.getBoundingClientRect();
    dropdown.style.cssText = `position:fixed; top:${rect.bottom + 2}px; left:${rect.left}px; background:white; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.3); z-index:10000; min-width:200px;`;

    document.body.appendChild(dropdown);
  }

  function hideDropdown() {
    const dropdown = document.getElementById('field-dropdown');
    if (dropdown) {
      dropdown.remove();
    }
    currentDropdownInput = null;
  }

  function hideDropdownDelayed() {
    // Delay hiding to allow clicking on checkboxes
    hideTimeout = setTimeout(hideDropdown, 200);
  }

  function updateMortalityFromDropdown(checkbox) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    const dropdown = checkbox.closest('div');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const values = Array.from(checkboxes).map(cb => cb.value);

    if (currentDropdownInput) {
      currentDropdownInput.value = values.join(', ');
      autoSaveUserLog();
    }
  }

  function updateCullFromDropdown(checkbox) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    const dropdown = checkbox.closest('div');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
    const values = Array.from(checkboxes).map(cb => cb.value);

    if (currentDropdownInput) {
      currentDropdownInput.value = values.join(', ');
      autoSaveUserLog();
    }
  }

  function updateAirSensoryFromDropdown(radio) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    if (currentDropdownInput) {
      currentDropdownInput.value = radio.value;
      autoSaveUserLog();
      // Close dropdown after selection since it's radio (single choice)
      setTimeout(hideDropdown, 100);
    }
  }

  function updateWeatherFromDropdown(radio) {
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }

    if (currentDropdownInput) {
      currentDropdownInput.value = radio.value;
      autoSaveUserLog();
      // Close dropdown after selection since it's radio (single choice)
      setTimeout(hideDropdown, 100);
    }
  }

  function updateCheckboxField(checkbox) {
    // Update the value based on checkbox state
    const value = checkbox.checked ? 'Yes' : 'No';
    // We need to trigger auto-save with the updated value
    // The checkbox doesn't have a "value" attribute in the traditional sense for form data
    // So we'll need to handle it in the autoSaveUserLog function
    autoSaveUserLog();
  }

  let saveTimeout = null;
  function autoSaveUserLog() {
    // Clear any existing timeout
    if (saveTimeout) {
      clearTimeout(saveTimeout);
    }

    // Set a new timeout to save after a brief delay (debounce)
    saveTimeout = setTimeout(() => {
      const form = document.getElementById('userlog-edit-form');
      const data = {};

      // Handle regular inputs
      const inputs = form.querySelectorAll('input[type="text"], input[type="number"], input[type="time"], input[type="hidden"], textarea');
      inputs.forEach(input => {
        if (input.name && input.name !== 'id' && input.name !== 'date_entered') {
          data[input.name] = input.value;
        }
      });

      // Handle checkboxes - convert to Yes/No
      const checkboxes = form.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (checkbox.name && checkbox.name !== 'id' && checkbox.name !== 'date_entered') {
          data[checkbox.name] = checkbox.checked ? 'Yes' : 'No';
        }
      });

      fetch('/update_user_log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          console.log('Auto-saved:', result.message);
        })
        .catch(err => {
          console.error('Auto-save failed:', err);
        });
    }, 500); // Wait 500ms after user stops typing
  }

  function renderBotLog(bot_log) {
    const container = document.getElementById('botlog-container');
    if (!bot_log) {
      container.innerHTML = '<p>No bot log for today.</p>';
      return;
    }

    let html = '<div style="max-width:100%; max-height:220px; overflow:auto; border:1px solid #ccc; border-radius:6px;">';
    html += '<form id="botlog-edit-form"><table style="font-size:12px; min-width:600px;"><tr>';
    html += '<th style="padding:4px 6px;">Flag</th>';
    for (const key in bot_log) {
      html += `<th style="padding:4px 6px;">${key}</th>`;
    }
    html += '<th style="padding:4px 6px;">Save</th></tr><tr>';
    html += '<td style="padding:4px 6px;"><input type="checkbox" id="botlog-flag" onchange="setFlag(\'BOT_LOG_FLAG\', this.checked)"></td>';
    for (const key in bot_log) {
      const value = bot_log[key] || '';
      html += `<td style="padding:4px 6px;"><input style="width:100px; font-size:12px;" name="${key}" value="${value}"></td>`;
    }
    html += '<td><button type="button" onclick="saveBotLog()">Save</button></td>';
    html += '</tr></table></form></div>';
    container.innerHTML = html;
  }

  function setFlag(flag, checked) {
    if (!checked) return; // Only set flag on check
    fetch('/set_flag', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ flag: flag })
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error setting flag.'));
  }

  function saveUserLog() {
    const form = document.getElementById('userlog-edit-form');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    fetch('/update_user_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error saving user log.'));
  }

  function saveBotLog() {
    const form = document.getElementById('botlog-edit-form');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    fetch('/update_bot_log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(() => alert('Error saving bot log.'));
  }
</script>
