<div id="settings" class="tabcontent" style="display:none;">
  <h2>Settings</h2>

  <!-- Unified Settings Form -->
  <form id="settingsForm" onsubmit="saveAllSettings(event)">
    <h3>Basic Information</h3>
    <div class="spinner-container">
      <span class="spinner-label">Hatch Date</span>
      <input type="date" id="hatchDate" name="hatchDate">
    </div>
    <div class="spinner-container">
      <span class="spinner-label">Birds Arrived Date</span>
      <input type="date" id="birdsArrivedDate" name="birdsArrivedDate">
    </div>
    <div class="spinner-container">
      <span class="spinner-label">NWS Station ID</span>
      <input type="text" id="nws_station_id" name="nws_station_id" placeholder="e.g. KBOS" maxlength="4" style="text-transform:uppercase;">
    </div>
    <p style="font-size:12px; color:#666; margin-left:160px;">Enter your nearest NWS station ID for auto-weather. Leave blank to disable.<br>Find stations at <a href="https://www.weather.gov/" target="_blank">weather.gov</a></p>
    <h3>System Configuration</h3>

    <div class="spinner-container" style="display:none;">
      <span class="spinner-label">XML Directory Path</span>
      <input type="text" id="path_to_xmls" name="path_to_xmls" style="width:300px;">
    </div>

    <div class="spinner-container" style="display:none;">
      <span class="spinner-label">Days to Keep Old Files</span>
      <input type="number" id="how_long_to_save_old_files" name="how_long_to_save_old_files" min="0" style="width:100px;">
      <span style="font-size:12px; color:#666; margin-left:10px;">(0 to disable, 2 recommended)</span>
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Time Zone</span>
      <input type="text" id="time_zone" name="time_zone" placeholder="America/Chicago" style="width:200px;">
    </div>

    <h3 style="margin-top:30px;">Scheduling</h3>

    <div class="spinner-container" style="display:none;">
      <span class="spinner-label">Retrieve XML Time</span>
      <input type="time" id="retrieve_from_xml_time" name="retrieve_from_xml_time" step="1">
      <span style="font-size:12px; color:#666; margin-left:10px;">(00:15:00 recommended)</span>
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Cooler Temp AM</span>
      <input type="time" id="get_cooler_temp_AM" name="get_cooler_temp_AM" step="1">
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Cooler Temp PM</span>
      <input type="time" id="get_cooler_temp_PM" name="get_cooler_temp_PM" step="1">
    </div>

    <div class="spinner-container" style="display:none;">
      <span class="spinner-label">Cooler Temp Tolerance</span>
      <input type="time" id="cooler_temp_time_tolerance" name="cooler_temp_time_tolerance" step="1">
    </div>

    <h3 style="margin-top:30px;">Telegram Notifications</h3>

    <div class="spinner-container">
      <span class="spinner-label">Bot Token</span>
      <input type="password" id="telegram_bot_token" name="telegram_bot_token" style="width:300px;" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
      <button type="button" onclick="togglePasswordVisibility('telegram_bot_token')" style="margin-left:10px;">Show</button>
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Chat ID</span>
      <input type="password" id="telegram_chat_id" name="telegram_chat_id" style="width:200px;" placeholder="123456789">
      <button type="button" onclick="togglePasswordVisibility('telegram_chat_id')" style="margin-left:10px;">Show</button>
    </div>
    <p style="font-size:12px; color:#666; margin-left:160px;">Configure Telegram bot for XML watcher alerts. Leave blank to disable.</p>

    <h3 style="margin-top:30px;">Unitas Integration</h3>

    <div class="spinner-container">
      <span class="spinner-label">Unitas Username</span>
      <input type="text" id="Unitas_Username" name="Unitas_Username" autocomplete="off">
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Unitas Password</span>
      <input type="password" id="Unitas_Password" name="Unitas_Password" autocomplete="off">
      <button type="button" onclick="togglePasswordVisibility('Unitas_Password')" style="margin-left:10px;">Show</button>
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Farm ID</span>
      <input type="text" id="Farm_ID" name="Farm_ID">
    </div>

    <div class="spinner-container">
      <span class="spinner-label">House ID</span>
      <input type="text" id="House_ID" name="House_ID">
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Cooler Log Initials</span>
      <input type="text" id="Cooler_Log_Initials" name="Cooler_Log_Initials" maxlength="10">
    </div>

    <div class="spinner-container">
      <span class="spinner-label">Enable Cooler Log</span>
      <input type="checkbox" id="Cooler_Log_To_Unitas" name="Cooler_Log_To_Unitas">
    </div>

    <button type="submit" class="floating-btn" style="position:static; margin-top:20px;">Save Settings</button>
    <div id="settingsMsg" style="margin-top:10px;"></div>
  </form>
</div>

<script>
  let settingsHasUnsavedChanges = false;

  // Load settings when Settings tab is opened
  document.addEventListener('DOMContentLoaded', function() {
    const settingsTab = document.querySelector('[onclick*="settings"]');
    if (settingsTab) {
      settingsTab.addEventListener('click', function() {
        loadAllSettings();
      });
    }

    // Track changes to form fields
    const form = document.getElementById('settingsForm');
    if (form) {
      form.addEventListener('input', function() {
        settingsHasUnsavedChanges = true;
      });
    }

    // Warn on page unload if unsaved changes
    window.addEventListener('beforeunload', function(e) {
      if (settingsHasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });
  });

  function loadAllSettings() {
    // Load basic settings
    fetch('/get_settings')
      .then(res => res.json())
      .then(data => {
        if (data.hatch_date) document.getElementById('hatchDate').value = data.hatch_date;
        if (data.birds_arrived_date) document.getElementById('birdsArrivedDate').value = data.birds_arrived_date;
        if (data.nws_station_id) document.getElementById('nws_station_id').value = data.nws_station_id;
      })
      .catch(err => console.error('Error loading settings:', err));

    // Load system config
    fetch('/get_secrets')
      .then(res => res.json())
      .then(data => {
        if (data.path_to_xmls) document.getElementById('path_to_xmls').value = data.path_to_xmls;
        if (data.how_long_to_save_old_files !== undefined) document.getElementById('how_long_to_save_old_files').value = data.how_long_to_save_old_files;
        if (data.time_zone) document.getElementById('time_zone').value = data.time_zone;
        if (data.retrieve_from_xml_time) document.getElementById('retrieve_from_xml_time').value = data.retrieve_from_xml_time;
        if (data.get_cooler_temp_AM) document.getElementById('get_cooler_temp_AM').value = data.get_cooler_temp_AM;
        if (data.get_cooler_temp_PM) document.getElementById('get_cooler_temp_PM').value = data.get_cooler_temp_PM;
        if (data.cooler_temp_time_tolerance) document.getElementById('cooler_temp_time_tolerance').value = data.cooler_temp_time_tolerance;
        if (data.telegram_bot_token) document.getElementById('telegram_bot_token').value = data.telegram_bot_token;
        if (data.telegram_chat_id) document.getElementById('telegram_chat_id').value = data.telegram_chat_id;
        if (data.Unitas_Username) document.getElementById('Unitas_Username').value = data.Unitas_Username;
        if (data.Unitas_Password) document.getElementById('Unitas_Password').value = data.Unitas_Password;
        if (data.Farm_ID) document.getElementById('Farm_ID').value = data.Farm_ID;
        if (data.House_ID) document.getElementById('House_ID').value = data.House_ID;
        if (data.Cooler_Log_Initials) document.getElementById('Cooler_Log_Initials').value = data.Cooler_Log_Initials;
        document.getElementById('Cooler_Log_To_Unitas').checked = data.Cooler_Log_To_Unitas === true;
        settingsHasUnsavedChanges = false;
      })
      .catch(err => console.error('Error loading config:', err));
  }

  function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = event.target;
    if (field.type === 'password') {
      field.type = 'text';
      button.textContent = 'Hide';
    } else {
      field.type = 'password';
      button.textContent = 'Show';
    }
  }

  async function saveAllSettings(event) {
    event.preventDefault();

    const msgDiv = document.getElementById('settingsMsg');
    msgDiv.textContent = 'Saving...';
    msgDiv.style.color = '#666';

    try {
      // Save basic settings
      await fetch('/save_settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          hatch_date: document.getElementById('hatchDate').value,
          birds_arrived_date: document.getElementById('birdsArrivedDate').value,
          nws_station_id: document.getElementById('nws_station_id').value.toUpperCase()
        })
      });

      // Save system config
      await fetch('/save_secrets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          path_to_xmls: document.getElementById('path_to_xmls').value,
          how_long_to_save_old_files: parseInt(document.getElementById('how_long_to_save_old_files').value),
          time_zone: document.getElementById('time_zone').value,
          retrieve_from_xml_time: document.getElementById('retrieve_from_xml_time').value,
          get_cooler_temp_AM: document.getElementById('get_cooler_temp_AM').value,
          get_cooler_temp_PM: document.getElementById('get_cooler_temp_PM').value,
          cooler_temp_time_tolerance: document.getElementById('cooler_temp_time_tolerance').value,
          telegram_bot_token: document.getElementById('telegram_bot_token').value,
          telegram_chat_id: document.getElementById('telegram_chat_id').value,
          Unitas_Username: document.getElementById('Unitas_Username').value,
          Unitas_Password: document.getElementById('Unitas_Password').value,
          Farm_ID: document.getElementById('Farm_ID').value,
          House_ID: document.getElementById('House_ID').value,
          Cooler_Log_Initials: document.getElementById('Cooler_Log_Initials').value,
          Cooler_Log_To_Unitas: document.getElementById('Cooler_Log_To_Unitas').checked
        })
      });

      msgDiv.textContent = 'All settings saved successfully!';
      msgDiv.style.color = 'green';
      settingsHasUnsavedChanges = false;

      // Clear message after 3 seconds
      setTimeout(() => {
        msgDiv.textContent = '';
      }, 3000);

    } catch (error) {
      msgDiv.textContent = 'Error saving settings: ' + error.message;
      msgDiv.style.color = 'red';
    }
  }
</script>
