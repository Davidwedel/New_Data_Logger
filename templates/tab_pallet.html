<div id="pallet" class="tabcontent">
  <h2>Pallet Entry</h2>
  <table>
    <thead>
      <tr>
        <th>Pallet ID</th>
        <th>Total Pallet Weight (lbs)</th>
        <th>Case Weight (lbs)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" id="palletId" placeholder="Enter Pallet ID"></td>
        <td><input type="number" id="palletWeight" value="0" min="0" step="1"></td>
        <td><input type="number" id="caseWeight" value="0" min="0" step="0.01"></td>
      </tr>
    </tbody>
  </table>
  <br>

  <p><strong>Yolk Color:</strong></p>
  <label><input type="radio" name="yolkColor" value="A"> A</label><br>
  <label><input type="radio" name="yolkColor" value="B"> B</label><br>
  <label><input type="radio" name="yolkColor" value="C"> C</label><br>
  <label><input type="radio" name="yolkColor" value="D"> D</label><br>
  <label><input type="radio" name="yolkColor" value="E"> E</label>
  <br>
  <br>
  <button onclick="submitPallets()">Submit Pallet Data</button>

  <br>
  <br>
  <h3>Recent Pallet Entries</h3>
  <div id="palletLogContainer">
    <table id="palletLogTable" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Pallet ID</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Total Weight (lbs)</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Case Weight (lbs)</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Yolk Color</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Delete</th>
        </tr>
      </thead>
      <tbody id="palletLogBody">
        <tr>
          <td colspan="6" style="text-align: center; padding: 16px;">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Configuration values for weight calculations
  let palletTare = 192;  // Default, will be fetched from config
  let casesPerPallet = 30;  // Default, will be fetched from config
  let isCalculating = false;  // Prevent circular calculation
  let currentPalletId = null;  // Track which pallet we're currently editing
  let palletSaveTimeout = null;  // For debounced auto-save

  // Fetch pallet configuration from server
  async function fetchPalletConfig() {
    try {
      const response = await fetch("/config");
      if (response.ok) {
        const config = await response.json();
        palletTare = config.farm?.pallet_tare || 192;
        casesPerPallet = config.farm?.cases_per_pallet || 30;
      }
    } catch (error) {
      console.warn("Could not fetch pallet config, using defaults:", error);
    }
  }

  // Auto-save current pallet to database (debounced)
  function autoSavePallet() {
    if (!currentPalletId) {
      console.warn("No current pallet ID to auto-save");
      return;
    }

    // Clear previous timeout
    if (palletSaveTimeout) {
      clearTimeout(palletSaveTimeout);
    }

    // Set new timeout - save after 500ms of no typing
    palletSaveTimeout = setTimeout(() => {
      const palletId = document.getElementById("palletId").value;
      const weight = document.getElementById("palletWeight").value;
      const caseWeight = document.getElementById("caseWeight").value;
      const yolkColor = document.querySelector('input[name="yolkColor"]:checked')?.value || "";

      fetch(`/update_pallet/${currentPalletId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          pallet_id: palletId,
          weight: weight,
          case_weight: caseWeight,
          yolk_color: yolkColor
        })
      })
      .then(res => res.json())
      .then(result => {
        console.log('Auto-saved pallet:', result.message);
      })
      .catch(err => {
        console.error('Auto-save failed:', err);
      });
    }, 500);  // 500ms debounce delay
  }

  // Calculate case weight from total weight
  function calculateCaseWeight() {
    if (isCalculating) return;
    isCalculating = true;

    const totalWeight = parseFloat(document.getElementById("palletWeight").value) || 0;
    const caseWeight = (totalWeight - palletTare) / casesPerPallet;
    document.getElementById("caseWeight").value = caseWeight.toFixed(2);

    isCalculating = false;
    autoSavePallet();  // Trigger auto-save after calculation
  }

  // Calculate total weight from case weight
  function calculateTotalWeight() {
    if (isCalculating) return;
    isCalculating = true;

    const caseWeight = parseFloat(document.getElementById("caseWeight").value) || 0;
    const totalWeight = (caseWeight * casesPerPallet) + palletTare;
    document.getElementById("palletWeight").value = Math.round(totalWeight);

    isCalculating = false;
    autoSavePallet();  // Trigger auto-save after calculation
  }

  // Set up event listeners for auto-save and bidirectional calculation
  function setupWeightCalculation() {
    document.getElementById("palletWeight").addEventListener("input", calculateCaseWeight);
    document.getElementById("caseWeight").addEventListener("input", calculateTotalWeight);
    document.getElementById("palletId").addEventListener("input", autoSavePallet);

    // Add auto-save to yolk color radio buttons
    document.querySelectorAll('input[name="yolkColor"]').forEach(radio => {
      radio.addEventListener("change", autoSavePallet);
    });
  }

  async function loadPalletLog() {
    try {
      const response = await fetch("/get_pallet_logs");
      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const logs = await response.json();
      const tbody = document.getElementById("palletLogBody");

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 16px;">No pallet entries yet</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => {
        const caseWeight = log.case_weight ? log.case_weight.toFixed(2) : 'N/A';
        const totalWeight = log.total_pallet_weight ? log.total_pallet_weight.toFixed(0) : 'N/A';
        return `
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.thedate || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.pallet_id || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${totalWeight}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${caseWeight}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.yolk_color || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
              <button onclick="deletePallet(${log.id})" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 3px;">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    } catch (error) {
      console.error("Failed to load pallet log:", error);
      document.getElementById("palletLogBody").innerHTML =
        '<tr><td colspan="6" style="text-align: center; padding: 16px; color: red;">Error loading pallet log</td></tr>';
    }
  }

  async function deletePallet(palletId) {
    if (!confirm("Are you sure you want to delete this pallet entry?")) {
      return;
    }

    try {
      const response = await fetch(`/delete_pallet/${palletId}`, {
        method: "DELETE"
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      console.log(result.message);

      // Reload the pallet log to show updated list
      loadPalletLog();
    } catch (error) {
      console.error("Delete failed:", error);
      alert("Failed to delete pallet entry. Please try again.");
    }
  }

  async function submitPallets() {
    // Get current yolk color to pass to the new pallet
    const yolkColor = document.querySelector('input[name="yolkColor"]:checked')?.value || "";

    try {
      // Create a new pallet entry with next ID and same yolk color
      const response = await fetch("/create_new_pallet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          yolk_color: yolkColor
        })
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const newPallet = await response.json();
      console.log("Created new pallet:", newPallet);

      // Load the new pallet into the form
      loadPalletIntoForm(newPallet);

      // Reload the pallet log to show all entries
      loadPalletLog();
    } catch (error) {
      console.error("Submit failed:", error);
      alert("Failed to create new pallet entry. Please try again.");
    }
  }

  // Load a pallet object into the form
  function loadPalletIntoForm(pallet) {
    // Set the current pallet ID we're editing
    currentPalletId = pallet.id;

    // Fill in the form
    document.getElementById("palletId").value = pallet.pallet_id || "";
    document.getElementById("palletWeight").value = pallet.total_pallet_weight || 0;
    document.getElementById("caseWeight").value = pallet.case_weight ? pallet.case_weight.toFixed(2) : "0.00";

    // Set yolk color if available
    if (pallet.yolk_color) {
      const radio = document.querySelector(`input[name="yolkColor"][value="${pallet.yolk_color}"]`);
      if (radio) {
        radio.checked = true;
      }
    }

    console.log(`Loaded pallet ID ${currentPalletId} into form`);
  }

  // Smart page load: Check if we need to create a new pallet entry
  async function loadCurrentPallet() {
    try {
      // Get the most recent pallet
      const response = await fetch("/get_current_pallet");
      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const pallet = await response.json();

      // Check if pallet exists and is complete
      // A pallet is complete if it has yolk_color AND at least one weight > 0
      const hasYolkColor = pallet.yolk_color && pallet.yolk_color !== "";
      const hasWeight = (pallet.total_pallet_weight && pallet.total_pallet_weight > 0) ||
                        (pallet.case_weight && pallet.case_weight > 0);
      const isComplete = hasYolkColor && hasWeight;

      if (!pallet.id || isComplete) {
        // No pallet exists OR current pallet is complete
        // Create a new pallet entry
        console.log("Creating new pallet entry...");
        const createResponse = await fetch("/create_new_pallet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            yolk_color: pallet.yolk_color || ""  // Carry over yolk color if exists
          })
        });

        if (!createResponse.ok) {
          throw new Error(`Failed to create new pallet: ${createResponse.status}`);
        }

        const newPallet = await createResponse.json();
        loadPalletIntoForm(newPallet);
      } else {
        // Current pallet is incomplete, continue editing it
        console.log("Loading existing incomplete pallet...");
        loadPalletIntoForm(pallet);
      }
    } catch (error) {
      console.error('Failed to load current pallet:', error);
      // If there's an error, just set currentPalletId to null
      currentPalletId = null;
    }
  }

  // Load pallet log, config, and current pallet when page loads
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await fetchPalletConfig();
      setupWeightCalculation();
      await loadCurrentPallet();  // Load or create current pallet
    } catch (error) {
      console.error('Error during page initialization:', error);
    } finally {
      // Always load the pallet log table, even if there was an error above
      loadPalletLog();
    }
  });
</script>
