<div id="pallet" class="tabcontent">
  <h2>Pallet Entry</h2>
  <table>
    <thead>
      <tr>
        <th>Pallet ID</th>
        <th>Total Pallet Weight (lbs)</th>
        <th>Case Weight (lbs)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" id="palletId" placeholder="Enter Pallet ID"></td>
        <td><input type="number" id="palletWeight" value="0" min="0" step="1"></td>
        <td><input type="number" id="caseWeight" value="0" min="0" step="0.01"></td>
      </tr>
    </tbody>
  </table>
  <br>

  <p><strong>Yolk Color:</strong></p>
  <label><input type="radio" name="yolkColor" value="A"> A</label><br>
  <label><input type="radio" name="yolkColor" value="B"> B</label><br>
  <label><input type="radio" name="yolkColor" value="C"> C</label><br>
  <label><input type="radio" name="yolkColor" value="D"> D</label><br>
  <label><input type="radio" name="yolkColor" value="E"> E</label>
  <br>
  <br>
  <button onclick="submitPallets()">Submit Pallet Data</button>

  <br>
  <br>
  <h3>Recent Pallet Entries</h3>
  <div id="palletLogContainer">
    <table id="palletLogTable" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 8px; border: 1px solid #ddd;">Date</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Pallet ID</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Total Weight (lbs)</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Case Weight (lbs)</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Yolk Color</th>
          <th style="padding: 8px; border: 1px solid #ddd;">Delete</th>
        </tr>
      </thead>
      <tbody id="palletLogBody">
        <tr>
          <td colspan="6" style="text-align: center; padding: 16px;">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Configuration values for weight calculations
  let palletTare = 192;  // Default, will be fetched from config
  let casesPerPallet = 30;  // Default, will be fetched from config
  let isCalculating = false;  // Prevent circular calculation

  // Fetch pallet configuration from server
  async function fetchPalletConfig() {
    try {
      const response = await fetch("/config");
      if (response.ok) {
        const config = await response.json();
        palletTare = config.farm?.pallet_tare || 192;
        casesPerPallet = config.farm?.cases_per_pallet || 30;
      }
    } catch (error) {
      console.warn("Could not fetch pallet config, using defaults:", error);
    }
  }

  // Calculate case weight from total weight
  function calculateCaseWeight() {
    if (isCalculating) return;
    isCalculating = true;

    const totalWeight = parseFloat(document.getElementById("palletWeight").value) || 0;
    const caseWeight = (totalWeight - palletTare) / casesPerPallet;
    document.getElementById("caseWeight").value = caseWeight.toFixed(2);

    isCalculating = false;
  }

  // Calculate total weight from case weight
  function calculateTotalWeight() {
    if (isCalculating) return;
    isCalculating = true;

    const caseWeight = parseFloat(document.getElementById("caseWeight").value) || 0;
    const totalWeight = (caseWeight * casesPerPallet) + palletTare;
    document.getElementById("palletWeight").value = Math.round(totalWeight);

    isCalculating = false;
  }

  // Set up event listeners for bidirectional calculation
  function setupWeightCalculation() {
    document.getElementById("palletWeight").addEventListener("input", calculateCaseWeight);
    document.getElementById("caseWeight").addEventListener("input", calculateTotalWeight);
  }

  async function loadPalletLog() {
    try {
      const response = await fetch("/get_pallet_logs");
      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const logs = await response.json();
      const tbody = document.getElementById("palletLogBody");

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 16px;">No pallet entries yet</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => {
        const caseWeight = log.case_weight ? log.case_weight.toFixed(2) : 'N/A';
        const totalWeight = log.total_pallet_weight ? log.total_pallet_weight.toFixed(0) : 'N/A';
        return `
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.thedate || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.pallet_id || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${totalWeight}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${caseWeight}</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${log.yolk_color || 'N/A'}</td>
            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
              <button onclick="deletePallet(${log.id})" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 3px;">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    } catch (error) {
      console.error("Failed to load pallet log:", error);
      document.getElementById("palletLogBody").innerHTML =
        '<tr><td colspan="6" style="text-align: center; padding: 16px; color: red;">Error loading pallet log</td></tr>';
    }
  }

  async function deletePallet(palletId) {
    if (!confirm("Are you sure you want to delete this pallet entry?")) {
      return;
    }

    try {
      const response = await fetch(`/delete_pallet/${palletId}`, {
        method: "DELETE"
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      console.log(result.message);

      // Reload the pallet log to show updated list
      loadPalletLog();
    } catch (error) {
      console.error("Delete failed:", error);
      alert("Failed to delete pallet entry. Please try again.");
    }
  }

  async function submitPallets() {
    const palletId = document.getElementById("palletId").value;
    const weight = document.getElementById("palletWeight").value;
    const caseWeight = document.getElementById("caseWeight").value;
    const yolkColor = document.querySelector('input[name="yolkColor"]:checked')?.value || "";

    try {
      const response = await fetch("/add_pallet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          pallet_id: palletId,
          weight: weight,
          case_weight: caseWeight,
          yolk_color: yolkColor
        })
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const result = await response.json();
      alert(result.message);

      // Increment pallet ID by 1
      const palletIdInput = document.getElementById("palletId");
      const currentId = palletIdInput.value;
      // Try to parse as number and increment, otherwise just clear it
      const numericId = parseInt(currentId);
      if (!isNaN(numericId)) {
        palletIdInput.value = numericId + 1;
      } else {
        palletIdInput.value = '';
      }

      // Reset both weight fields to 0
      document.getElementById("palletWeight").value = 0;
      document.getElementById("caseWeight").value = 0;

      // Keep yolk color selected (don't reset it)

      // Reload the pallet log to show the new entry
      loadPalletLog();
    } catch (error) {
      console.error("Submit failed:", error);
      alert("Failed to save pallet data. Please try again.");
    }
  }

  // Load pallet log and setup weight calculation when page loads
  document.addEventListener('DOMContentLoaded', async () => {
    await fetchPalletConfig();
    setupWeightCalculation();
    loadPalletLog();
  });
</script>
