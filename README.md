# Poultry Farm Data Logger

A comprehensive data logging and management system for poultry farms that automates data collection from farm equipment, provides a web interface for manual data entry, and automatically uploads production data to Unitas (poultrycloud.com).

## Features

- **Automated Data Collection**: Extracts production data from XML files generated by farm equipment
- **Web Interface**: User-friendly Flask web app for daily data entry and viewing
- **Unitas Integration**: Automatic upload of production and cooler log data to Unitas
- **Telegram Notifications**: XML watcher alerts via Telegram bot
- **Cooler Temperature Logging**: Scheduled temperature monitoring with backup database
- **Data Validation**: Real-time validation with visual feedback
- **Systemd Service**: Runs as a background service for automated daily operations

## Quick Start

### Installation

1. Clone the repository:
```bash
cd ~/projects
git clone https://github.com/davidwedel/newdatalog
cd newdatalog
```

2. Run the installation script:
```bash
chmod +x install.sh
./install.sh
```

This will:
- Install system dependencies (vsftpd, python3)
- Set up Python virtual environment
- Create systemd services
- Configure FTP server for XML uploads
- Set up SELinux policies (if applicable)

3. Edit configuration:
```bash
nano ~/.datalogger/config.json
```

Fill in your farm settings, Unitas credentials, and other configuration options.

4. Start services:
```bash
sudo systemctl start datalogger.service
sudo systemctl start farm-webapp.service
sudo systemctl start xml-watcher.service
```

5. Access the web interface:
```
http://localhost:5000
```

## Configuration

All configuration is stored in `~/.datalogger/config.json`:

```json
{
  "farm": {
    "hatch_date": "2025-03-05",
    "birds_arrived_date": "2025-06-01",
    "nws_station_id": "KMPR",
    "floor_eggs_through_belt": false
  },
  "unitas": {
    "username": "your_username",
    "password": "your_password",
    "farm_id": "your_farm_id",
    "house_id": "your_house_id",
    "cooler_log_enabled": true,
    "cooler_log_initials": "XX"
  },
  "xml": {
    "path": "/srv/ftp/upload/",
    "retention_days": 2,
    "retrieve_time": "00:15"
  },
  "cooler": {
    "am_time": "06:00:00",
    "pm_time": "18:00:00",
    "time_tolerance": "00:30"
  },
  "system": {
    "time_zone": "America/Chicago",
    "timeout": 30
  },
  "telegram": {
    "bot_token": "",
    "chat_id": ""
  }
}
```

You can also edit configuration through the web interface Settings tab.

## Usage

### Daily Data Entry

1. Open the web interface
2. Navigate to "Daily Farm Data Entry" tab
3. Fill in required fields (highlighted with red border if empty):
   - Belt eggs
   - Floor eggs (with +/- incremental entry)
   - Weather (auto-filled from NWS if configured)
   - Air sensory
   - Nutritionist (auto-filled from previous day)
   - Ration used (auto-filled from previous day)
4. Check "Send to Unitas" when ready to upload
5. Data is automatically saved as you type

### Manual Operations

Run specific operations manually:

```bash
# One-shot XML to Database
python automation.py --LogToDatabase

# One-shot Database to Unitas
python automation.py --LogToUnitas

# One-shot Cooler Log to Unitas
python automation.py --CoolerLogToUnitas

# Run web app only (for development)
python webapp.py
```

### Service Management

```bash
# View service status
sudo systemctl status datalogger.service
sudo systemctl status farm-webapp.service
sudo systemctl status xml-watcher.service

# View logs
sudo journalctl -u datalogger.service -f
sudo journalctl -u farm-webapp.service -f

# Restart services
sudo systemctl restart datalogger.service
sudo systemctl restart farm-webapp.service
```

## Architecture

### Data Flow

1. **XML → Database** (Scheduled daily)
   - Farm equipment generates XML files in `/srv/ftp/upload/`
   - `xml_processing.py` parses and extracts data
   - Stored in `~/.datalogger/database.db` (Daily_Bot_Log table)

2. **Web Interface → Database**
   - Users enter data via Flask web app
   - Stored in Daily_User_Log table
   - Auto-saves as you type

3. **Database → Unitas** (Triggered on checkbox)
   - When "Send to Unitas" is checked, uploads immediately via background thread
   - Daily cleanup job at 3 AM catches any missed uploads
   - Uses Selenium to automate Unitas form filling
   - Browser opens in foreground for visibility

4. **Cooler Log Backup** (Scheduled)
   - Backs up cooler temperatures to separate database
   - Stored in `~/.datalogger/coolerlog/coolerlog.db`

### Database Schema

- **Daily_Bot_Log**: Automated data from XMLs (temperatures, feed, water, lights, cooler temps)
- **Daily_User_Log**: Manual entries (eggs, mortality, observations, comments)
- **Pallet_Log**: Egg pallet tracking (weight, yolk color)

### Key Components

- `automation.py` - Main automation service, scheduling, forever mode
- `webapp.py` - Flask web application
- `server/config.py` - Configuration management
- `server/jobs.py` - Scheduled job definitions
- `server/database_helper.py` - SQLite operations
- `server/xml_processing.py` - XML parsing and data extraction
- `server/unitas_manager/` - Selenium automation for Unitas
- `watch_xml_dir.py` - Telegram notifications for new XML files

## Database

Main database: `~/.datalogger/database.db`

Backups:
- Daily backups at 00:05 in `~/.datalogger/backups/`
- Cooler log backups in `~/.datalogger/coolerlog/coolerlog.db`

## Data Validation

The system validates data before allowing upload to Unitas:

**Always Required:**
- Belt eggs
- Floor eggs
- Weather
- Air sensory
- Nutritionist
- Ration used

**Conditional Requirements:**
- If mortality > 0: Mortality reasons required
- If euthanized > 0: Cull reasons required
- If door times empty: Birds restricted reason required
- If ration delivered filled: Amount delivered required (and vice versa)

Fields with missing required data are highlighted with red borders.

## Scheduled Jobs

When running in forever mode (`python automation.py`):

- **00:05** - Daily database backup
- **00:15** (configurable) - XML → Database
- **00:16** - Cooler log backup
- **00:17** (if enabled) - Cooler log to Unitas
- **03:00** - Missed Unitas uploads cleanup

## Troubleshooting

### Browser won't open from systemd service

Ensure the service has DISPLAY access:
```bash
# Check systemd service has these environment variables:
Environment=DISPLAY=:0.0
Environment=XAUTHORITY=/run/lightdm/davidwedel/xauthority
```

### XML files not processing

1. Check FTP server is running: `sudo systemctl status vsftpd`
2. Check XML path in config: `~/.datalogger/config.json`
3. Check permissions on upload directory: `ls -la /srv/ftp/upload/`
4. View logs: `sudo journalctl -u datalogger.service -f`

### Unitas upload fails

1. Check credentials in config
2. Check Selenium/geckodriver is installed
3. Check browser can access Unitas website
4. View detailed logs in journalctl

### Database errors

1. Check database file exists: `ls -la ~/.datalogger/database.db`
2. Check permissions: `chmod 644 ~/.datalogger/database.db`
3. Restore from backup: `~/.datalogger/backups/database_*.db`

## Security Considerations

- Configuration file contains sensitive credentials (Unitas password, Telegram tokens)
- Database contains production data
- Consider adding HTTP authentication to web interface
- Use firewall to restrict web app access
- Keep system and Python packages updated

## Development

### Project Structure

```
newdatalog/
├── automation.py           # Main automation script
├── webapp.py              # Flask web application
├── watch_xml_dir.py       # XML watcher with Telegram notifications
├── install.sh             # Installation script
├── server/
│   ├── config.py          # Configuration management
│   ├── database_helper.py # Database operations
│   ├── helpers.py         # Utility functions
│   ├── jobs.py            # Scheduled jobs
│   ├── xml_processing.py  # XML parsing
│   └── unitas_manager/    # Unitas integration
│       ├── unitas_production.py
│       ├── unitas_coolerlog.py
│       └── unitas_login.py
├── templates/             # HTML templates
│   ├── base.html
│   ├── index.html
│   ├── tab_today.html
│   ├── tab_settings.html
│   └── ...
└── ~/.datalogger/         # Runtime data directory
    ├── config.json
    ├── database.db
    ├── backups/
    └── coolerlog/
```

### Adding New Features

See `CLAUDE.md` for detailed development guidance.

